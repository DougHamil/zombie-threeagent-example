{"version":3,"sources":["zombie/util/asset_loader.cljs"],"mappings":"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","names":["zombie.util.asset-loader/join-path","base","addition","clojure.string/starts-with?","zombie.util.asset-loader/leaf?","v","cljs.core/vector?","cljs.core/Keyword","cljs.core/second","zombie.util.asset-loader/find-refs","e","refs","cljs.core/transient","clojure.walk/postwalk","n","cljs.core/meta","cljs.core.conj_BANG_","cljs.core/first","cljs.core/set","cljs.core/persistent!","js/zombie","js/zombie.util","js/zombie.util.asset-loader","js/zombie.util.asset-loader.visit","method-table__4701__auto__","cljs.core.atom","prefer-table__4702__auto__","method-cache__4703__auto__","cached-hierarchy__4704__auto__","hierarchy__4705__auto__","cljs.core.get","fexpr__10537","cljs.core/MultiFn","cljs.core.symbol","zombie.util.asset-loader/visit","_ctx","node","ctx","vec__10538","cljs.core.nth","path","cfg","rest","cljs.core/map?","cljs.core.drop","cljs.core/rest","mw","cljs.core.concat","cljs.core.merge","cljs.core.mapcat","cljs.core.partial","p__10541","vec__10542","key","config","zombie.util.asset-loader/detect-duplicates!","nodes","dupes","cljs.core/group-by","p1__10545#","cljs.core.filter","cljs.core.not_EQ_","cljs.core/count","cljs.core.map","cljs.core/seq","cljs.core.ex_info","p__10546","map__10547","cljs.core/--destructure-map","zombie.util.asset-loader/detect-cycles!*","visited","references","seq__10548","chunk__10549","count__10550","i__10551","temp__5753__auto__","cljs.core/chunked-seq?","c__4638__auto__","cljs.core/chunk-first","cljs.core/chunk-rest","cljs.core/next","G__10558","G__10559","G__10560","G__10561","G__10562","G__10563","cljs.core.conj","zombie.util.asset-loader/detect-cycles!","seq__10564","chunk__10565","count__10566","i__10567","vec__10574","vec__10577","_","zombie.util.asset-loader/validate!","cljs.core.into","zombie.util.asset-loader/ref->promise","promises","database","js/Promise.all","p1__10580#","G__10581","G__10582","G__10583","G__10584","zombie.util.asset-loader/get-promise","zombie.util.asset-loader/resolve-config-refs","cljs.core/deref","p__10585","map__10586","loader","middleware","temp__5751__auto__","p","resolved-config","cljs.core.println","data","js/console.log","p__10587","vec__10588","result","cljs.core.reduce","cljs.core.swap_BANG_","cljs.core/assoc","zombie.util.asset-loader/load!","tree","cljs.core/vals","zombie.util.asset-loader/ref","asset-key"],"sourcesContent":["(ns zombie.util.asset-loader\r\n  (:require [clojure.walk :refer [postwalk]]\r\n            [clojure.string :as string]))\r\n\r\n(defn- join-path [base addition]\r\n  (let [addition (if (string/starts-with? addition \"/\")\r\n                   addition\r\n                   (str \"/\" addition))]\r\n    (str base addition)))\r\n\r\n(defn- leaf? [v]\r\n  (and (vector? v)\r\n       (keyword? (second v))))\r\n\r\n(defn- find-refs [e]\r\n  (let [refs (transient [])]\r\n    (->> e\r\n         (postwalk (fn [n]\r\n                     (when (:asset-ref (meta n))\r\n                       (conj! refs (first n)))\r\n                     n)))\r\n    (set (persistent! refs))))\r\n\r\n(defmulti visit\r\n  (fn [_ctx node]\r\n    (if (leaf? node)\r\n      :leaf\r\n      :branch)))\r\n\r\n(defmethod visit :branch [ctx node]\r\n  (let [path (join-path (:path ctx) (first node))\r\n        [cfg rest] (if (map? (second node))\r\n                     [(second node) (drop 2 node)]\r\n                     [{} (rest node)])\r\n        ;; Depth-first application of middleware\r\n        mw (concat (:middleware cfg [])\r\n                   (:middleware ctx []))\r\n        ctx (merge ctx\r\n                   cfg\r\n                   {:middleware mw\r\n                    :path path})]\r\n    (mapcat (partial visit ctx) rest)))\r\n        \r\n(defmethod visit :leaf [ctx [path key config]]\r\n  {key {:key key\r\n        :config config\r\n        :middleware (:middleware ctx)\r\n        :references (find-refs config)\r\n        :loader (:loader ctx)\r\n        :path (join-path (:path ctx) path)}})\r\n\r\n(defn- detect-duplicates! [nodes]\r\n  (let [dupes (->> nodes\r\n                   (group-by first)\r\n                   (filter #(not= 1 (count (second %))))\r\n                   (map first))]\r\n    (when (seq dupes)\r\n      (throw (ex-info \"Duplicate asset keys found\" {:duplicate-keys dupes})))))\r\n\r\n(defn- detect-cycles!* [nodes visited {:keys [key references]}]\r\n  (if (visited key)\r\n    (throw (ex-info \"Cycle detected\" {:path visited\r\n                                      :key key}))\r\n    (doseq [n references]\r\n      (detect-cycles!* nodes (conj visited key) (get nodes n)))))\r\n\r\n(defn- detect-cycles! [nodes]\r\n  (doseq [[_ n] nodes]\r\n    (detect-cycles!* nodes #{} n)))\r\n  \r\n(defn- validate! [nodes]\r\n  (detect-duplicates! nodes)\r\n  (detect-cycles! (into {} nodes))\r\n  nodes)\r\n\r\n(declare get-promise)\r\n\r\n(defn- ref->promise [nodes promises database references]\r\n  (js/Promise.all (map\r\n                   #(get-promise nodes promises database (get nodes %))\r\n                   references)))\r\n\r\n(defn- resolve-config-refs [database config]\r\n  (->> config\r\n       (postwalk (fn [n]\r\n                   (if (:asset-ref (meta n))\r\n                     (get @database (first n))\r\n                     n)))))\r\n\r\n(defn- get-promise [nodes promises database {:keys [key path config references loader middleware]}]\r\n  (if-let [p (get @promises key)]\r\n    p\r\n    (let [p (-> (ref->promise nodes promises database references)\r\n                (.then (fn [_]\r\n                         (let [resolved-config (resolve-config-refs database config)]\r\n                           (println \"Loading \" key)\r\n                           (-> (loader key path resolved-config)\r\n                               (.then (fn [data]\r\n                                        (js/console.log \"Loaded\" (str key) data)\r\n                                        [resolved-config data]))))))\r\n                (.then (fn [[resolved-config data]]\r\n                         (let [result (reduce (fn [data mw]\r\n                                                (mw key data resolved-config))\r\n                                              data\r\n                                              middleware)]\r\n                           (swap! database assoc key result)\r\n                           result))))]\r\n      (swap! promises assoc key p)\r\n      p)))\r\n\r\n(defn load! [database tree]\r\n  (let [nodes (->> tree\r\n                   (mapcat (partial visit {:path \"\" :middleware []}))\r\n                   (validate!)\r\n                   (into {}))\r\n        promises (atom {})]\r\n    (js/Promise.all (->> (vals nodes)\r\n                         (map (partial get-promise nodes promises database))))))\r\n\r\n(defn ref [asset-key]\r\n  ^{:asset-ref true}\r\n  [asset-key])\r\n"]}