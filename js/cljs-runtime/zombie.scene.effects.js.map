{"version":3,"sources":["zombie/scene/effects.cljs"],"mappings":";AAOA,uCAAA,kDAAAA,zFAAOI,sFAAiBC;AAAxB,AAAA,IAAAJ,aAAAD;IAAAC,iBAAA,AAAAC,4BAAAD;UAAAA,NAA0DO;eAA1D,AAAAL,4CAAAF,eAAA,tEAAmCK;eAAnC,AAAAH,4CAAAF,eAAA,tEAA4CM;AAA5C,AAAA,0FAAA,yDAAA,2CAAA,8DACsB,kDAAA,lDAACE,8CAAMD,+DACS;AAAA,AACE,AAACE,mDAAMC,iCAAaC,iBAAOP;;AAC3B,IAAAQ,qBAAc,AAAA,yFAAUL;AAAxB,AAAA,oBAAAK;AAAA,AAAA,SAAAA,LAAWC;AAAX,AACE,QAACA,mCAAAA,qCAAAA;;AADH;;IAJxC,uEAAA,TAMsBR,uEACAC;;AAEtB,2BAAA,sCAAAQ,jEAAOE,8DAAKZ;AAAZ,AAAA,IAAAW,aAAAD;IAAAC,iBAAA,AAAAd,4BAAAc;qBAAA,AAAAb,4CAAAa,eAAA,5EAAuBE;mBAAvB,AAAAf,4CAAAa,eAAA,1EAAsCG;AAAtC,AACE,IAAMC,OAAK,6CAAA,7CAACC;IACNC,eAAa,AAACC,0BAAcL,eAAeC;IAC3CK,MAAI,AAACC,2BAAeP,eAAeC;IACnCO,MAAI,AAACC,uDAAgCH;AAH3C,AAIE,kBAAKI,EAAEA;AAAP,AACE,YAAA,AAAAC,RAAMD,wBAAG,iBAAAE,WAAWG;IAAXF,WAAA,mFAAA;AAAA,AAAA,oHAAAD,SAAAC,6CAAAD,SAAAC,3KAACC,uDAAAA,0EAAAA;;SAAV,AAAAH,LACMK,qBAAI,iBAAAC,WAAWF;IAAXG,WAAA,mFAAA;AAAA,AAAA,oHAAAD,SAAAC,6CAAAD,SAAAC,3KAACJ,uDAAAA,0EAAAA;;IACLJ,QAAE,AAAClB,mDAAMU,KAAKiB,iBAAEH;IAChBI,IAAE,CAAA,AAAAT,wBAAA,RAAIT;IACNmB,SAAO,CAAGjB,eAAa,CAAA,MAAOgB;AAJpC,AAKE,GAAM,CAAA,MAAOA;AAAb,AACE,AAAC5B,mDAAM8B,4BAAQ5B,iBAAOP;;AADxB;;AALF,2BAAA,mFAAA,yDAAA,2CAAA,2EAAA,0EAAA,mFAAA,mDAAA,2CAAA,8DAAA,mFAAA,IAAA,4BAAA,+NAAA,uDAAA,mFAAA,IAAA,+BAAA,mFAAA,8DAAA,2CAAA,qPAAA,2CAAA,oDAOSA,r1CACac,2EACAO,sVACG,UAAA,TAAGa,mFACR,AAAA,mHAAA,AAAAV,gBAAyBY,kLACnB,GAAGF,6QACL,AAAA,4GAAA,AAAAV,gBAAsBY;;;AAEpD,kCAAA,8CAAAC,hFAAOE,4EAAYC;AAAnB,AAAA,IAAAF,aAAAD;IAAAC,iBAAA,AAAAzC,4BAAAyC;cAAA,AAAAxC,4CAAAwC,eAAA,rEAA+BG;qBAA/B,AAAA3C,4CAAAwC,eAAA,5EAAuCI;gBAAvC,AAAA5C,4CAAAwC,eAAA,vEAAgDK;AAAhD,AACE,IAAMT,SAAO,WAAA,VAAGO;IACVG,WAAS,UAAA,TAAGV;AADlB,AAAA,0FAAA,yDAAA,2CAAA,8DAAA,4FAAA,IAAA,bAEuBU,iCACpB,kCAAA,AAAA,mFAAA,mDAAA,2CAAA,2NAAA,8DAAA,mFAAA,yBAAA,YAAA,uDAAA,0FAAA,IAAA,YAAA,yDAAA,2CAAA,yEAAA,2EAAA,mFAAA,IAAA,IAAA,oCAAA,1mCAAMF,6PACa,AAAA,+GAAA,AAAAlB,gBAAuBY,qLACpBS,2KACLX,0LACYS;;AAGlC,iCAAA,jCAAOG;AAAP,AAAA,0FAAA,yDAEG,iBAAAC,qBAAA,uDAAAC;AAAA,AAAA,YAAAC,kBAAA,KAAA;AAAA,AAAA,IAAAD,eAAAA;;AAAA,AAAA,IAAAxC,qBAAA,AAAA0C,cAAAF;AAAA,AAAA,GAAAxC;AAAA,AAAA,IAAAwC,eAAAxC;AAAA,AAAA,GAAA,AAAA2C,6BAAAH;AAAA,IAAAI,kBAy4EgD,AAAAmC,sBAAAvC;IAz4EhDK,qBAAA,AAAAC,gBAAAF;IAAAG,WAAA,AAAAC,uBAAAH;AAAA,AAAA,GAAA,AAAA,iBAAAI,WAAA;;AAAA,AAAA,GAAA,CAAAA,WAAAJ;AAAA,IAAAK,aAAA,AAAAC,eAAAP,gBAAAK;SAAA,AAAAG,4CAAAF,WAAA,IAAA,hEAAO1D;eAAP,AAAA4D,4CAAAF,WAAA,IAAA,tEAAUY;AAAV,AAAA,AAAA,AAAAT,uBAAAN,SAAA,oBAAA,4IAAA,2CAAA,oDACSvD,xJACND,qCAAgBC,GAAGsE;;AAFtB,eAAA,CAAAb,WAAA;;;;AAAA;;;;;AAAA,OAAAK,qBAAA,AAAAC,gBAAAR,UAAA,AAAAS,6CAAA,AAAAC,qBAAAjB;;AAAA,OAAAc,qBAAA,AAAAC,gBAAAR,UAAA;;;AAAA,IAAAW,aAAA,AAAAC,gBAAAnB;SAAA,AAAAY,4CAAAM,WAAA,IAAA,hEAAOlE;eAAP,AAAA4D,4CAAAM,WAAA,IAAA,tEAAUI;AAAV,AAAA,OAAAF,eAAA,oBAAA,4IAAA,2CAAA,gEAAA,AAAAJ,6CAAA,AAAAK,eAAArB,xEACShD,xJACND,qCAAgBC,GAAGsE;;;AAFtB;;;;GAAA,KAAA;;AAAA,AAAA,OAAAvB,mBAAA,AAAAvB,gBAAqBlB;;;AAIxB,mCAAA,nCAAOiE;AAAP,AAAA,0FAAA,yDAEG,iBAAAxB,qBAAA,yDAAAyB;AAAA,AAAA,YAAAvB,kBAAA,KAAA;AAAA,AAAA,IAAAuB,eAAAA;;AAAA,AAAA,IAAAhE,qBAAA,AAAA0C,cAAAsB;AAAA,AAAA,GAAAhE;AAAA,AAAA,IAAAgE,eAAAhE;AAAA,AAAA,GAAA,AAAA2C,6BAAAqB;AAAA,IAAApB,kBAm4EgD,AAAAmC,sBAAAf;IAn4EhDnB,qBAAA,AAAAC,gBAAAF;IAAAqB,WAAA,AAAAjB,uBAAAH;AAAA,AAAA,GAAA,AAAA,iBAAAqB,WAAA;;AAAA,AAAA,GAAA,CAAAA,WAAArB;AAAA,IAAAsB,aAAA,AAAAhB,eAAAP,gBAAAsB;SAAA,AAAAd,4CAAAe,WAAA,IAAA,hEAAO3E;UAAP,AAAA4D,4CAAAe,WAAA,IAAA,jEAAUxE;AAAV,AAAA,AAAA,AAAA0D,uBAAAY,SAAA,oBAAA,kIAAA,2CAAA,oDACSzE,9IACNuC,gCAAWvC,GAAGG;;AAFjB,eAAA,CAAAuE,WAAA;;;;AAAA;;;;;AAAA,OAAAZ,qBAAA,AAAAC,gBAAAU,UAAA,AAAAG,+CAAA,AAAAX,qBAAAO;;AAAA,OAAAV,qBAAA,AAAAC,gBAAAU,UAAA;;;AAAA,IAAAI,aAAA,AAAAV,gBAAAK;SAAA,AAAAZ,4CAAAiB,WAAA,IAAA,hEAAO7E;UAAP,AAAA4D,4CAAAiB,WAAA,IAAA,jEAAU1E;AAAV,AAAA,OAAAiE,eAAA,oBAAA,kIAAA,2CAAA,gEAAA,AAAAQ,+CAAA,AAAAP,eAAAG,1EACSxE,9IACNuC,gCAAWvC,GAAGG;;;AAFjB;;;;GAAA,KAAA;;AAAA,AAAA,OAAA4C,mBAAA,AAAAvB,gBAAgBsD;;;AAInB,4BAAA,5BAAOC;AAAP,AAAA,0FAAA,yDAEG,iBAAAhC,qBAAA,kDAAAiC;AAAA,AAAA,YAAA/B,kBAAA,KAAA;AAAA,AAAA,IAAA+B,eAAAA;;AAAA,AAAA,IAAAxE,qBAAA,AAAA0C,cAAA8B;AAAA,AAAA,GAAAxE;AAAA,AAAA,IAAAwE,eAAAxE;AAAA,AAAA,GAAA,AAAA2C,6BAAA6B;AAAA,IAAA5B,kBA63EgD,AAAAmC,sBAAAP;IA73EhD3B,qBAAA,AAAAC,gBAAAF;IAAA6B,WAAA,AAAAzB,uBAAAH;AAAA,AAAA,GAAA,AAAA,iBAAA6B,WAAA;;AAAA,AAAA,GAAA,CAAAA,WAAA7B;AAAA,IAAA8B,aAAA,AAAAxB,eAAAP,gBAAA8B;SAAA,AAAAtB,4CAAAuB,WAAA,IAAA,hEAAOnF;UAAP,AAAA4D,4CAAAuB,WAAA,IAAA,jEAAUhF;AAAV,AAAA,AAAA,AAAA0D,uBAAAoB,SAAA,oBAAA,2HAAA,2CAAA,oDACSjF,vIACNY,yBAAIZ,GAAGG;;AAFV,eAAA,CAAA+E,WAAA;;;;AAAA;;;;;AAAA,OAAApB,qBAAA,AAAAC,gBAAAkB,UAAA,AAAAG,wCAAA,AAAAnB,qBAAAe;;AAAA,OAAAlB,qBAAA,AAAAC,gBAAAkB,UAAA;;;AAAA,IAAAI,aAAA,AAAAlB,gBAAAa;SAAA,AAAApB,4CAAAyB,WAAA,IAAA,hEAAOrF;UAAP,AAAA4D,4CAAAyB,WAAA,IAAA,jEAAUlF;AAAV,AAAA,OAAAiE,eAAA,oBAAA,2HAAA,2CAAA,gEAAA,AAAAgB,wCAAA,AAAAf,eAAAW,nEACShF,vIACNY,yBAAIZ,GAAGG;;;AAFV;;;;GAAA,KAAA;;AAAA,AAAA,OAAA4C,mBAAA,AAAAvB,gBAAgBW;;;AAInB,8BAAA,9BAAMmD;AAAN,AAAA,0FAAA,yDAAA,0HAAA,4HAAA,nKAEIxC,0HACAyB,4HACAQ","names":["p__10665","map__10666","cljs.core/--destructure-map","cljs.core.get","zombie.scene.effects/particle-system","id","rotation","position","cfg","cljs.core.assoc","cljs.core.swap_BANG_","zombie.state.databases/particles","cljs.core/dissoc","temp__5753__auto__","cb","p__10667","map__10668","zombie.scene.effects/ray","start-position","end-position","life","cljs.core.atom","start-length","zombie.util.math/distance","dir","zombie.util.math/direction","rot","zombie.util.threejs/direction-tuple->rotation-tuple","_","cljs.core/deref","G__10673","G__10674","threeagent.core/cursor","zombie.state.databases/game","dt","G__10675","G__10676","cljs.core/+","n","length","zombie.state.databases/rays","zombie.state.databases/assets","p__10677","map__10678","zombie.scene.effects/health-bar","_id","percent","visible?","entity-id","x-offset","zombie.util.math/pi4","zombie.scene.effects/particles","iter__4611__auto__","s__10682","cljs.core/LazySeq","cljs.core/seq","cljs.core/chunked-seq?","c__4609__auto__","size__4610__auto__","cljs.core/count","b__10684","cljs.core/chunk-buffer","i__10683","vec__10686","cljs.core/-nth","cljs.core.nth","cljs.core/chunk-append","cljs.core/chunk-cons","cljs.core/chunk","iter__10681","cljs.core/chunk-rest","vec__10689","cljs.core/first","cljs.core/cons","cljs.core/rest","particle","zombie.scene.effects/health-bars","s__10698","b__10700","i__10699","vec__10702","iter__10697","vec__10705","zombie.state.databases/health-bars","zombie.scene.effects/rays","s__10718","b__10720","i__10719","vec__10721","iter__10717","vec__10724","zombie.scene.effects/render","cljs.core/chunk-first"],"sourcesContent":["(ns zombie.scene.effects\r\n  \"Threeagent components for world-space visual effects (particles, bullet tracers, etc)\"\r\n  (:require [zombie.state.databases :as db]\r\n            [zombie.util.math :as math]\r\n            [zombie.util.threejs :refer [direction-tuple->rotation-tuple]]\r\n            [threeagent.core :as th]))\r\n\r\n(defn- particle-system [id {:keys [rotation position] :as cfg}]\r\n  [:object {:particle (assoc cfg\r\n                             :on-dead (fn []\r\n                                        (swap! db/particles dissoc id)\r\n                                        (when-let [cb (:on-dead cfg)]\r\n                                          (cb))))\r\n            :rotation rotation\r\n            :position position}])\r\n\r\n(defn- ray [id {:keys [start-position end-position]}]\r\n  (let [life (atom 0.0)\r\n        start-length (math/distance start-position end-position)\r\n        dir (math/direction start-position end-position)\r\n        rot (direction-tuple->rotation-tuple dir)]\r\n    (fn [_ _]\r\n      (let [_ @(th/cursor db/game [:time])\r\n            dt @(th/cursor db/game [:delta-time])\r\n            _ (swap! life + dt)\r\n            n (/ @life 0.2)\r\n            length (* start-length (- 1.0 n))]\r\n        (when (< 1.0 n)\r\n          (swap! db/rays dissoc id))\r\n        ^{:key id}\r\n        [:object {:position end-position\r\n                  :rotation rot}\r\n         [:box {:position [0 0 (/ length -2)]\r\n                :material (:material/laser-bullet @db/assets)\r\n                :scale [0.1 0.1 (- length)]}\r\n          [:instance {:object (:light/laser-bullet @db/assets)}]]]))))\r\n\r\n(defn- health-bar [_id {:keys [percent visible? entity-id]}]\r\n  (let [length (* percent 1.5)\r\n        x-offset (- length 1.5)]\r\n    [:object {:position [x-offset 0 0]}\r\n     (when visible?\r\n       [:box {:material (:material/health-bar @db/assets)\r\n              :rotation [0 math/pi4 0]\r\n              :scale [length 0.1 0.1]\r\n              :follow {:entity-id entity-id\r\n                       :position-offset [0 2 0]}}])]))\r\n\r\n(defn- particles []\r\n  [:object\r\n   (for [[id particle] @db/particles]\r\n     ^{:key id}\r\n     [particle-system id particle])])\r\n\r\n(defn- health-bars []\r\n  [:object\r\n   (for [[id cfg] @db/health-bars]\r\n     ^{:key id}\r\n     [health-bar id cfg])])\r\n\r\n(defn- rays []\r\n  [:object\r\n   (for [[id cfg] @db/rays]\r\n     ^{:key id}\r\n     [ray id cfg])])\r\n\r\n(defn render []\r\n  [:object\r\n   [particles]\r\n   [health-bars]\r\n   [rays]])\r\n"]}