{"version":3,"sources":["statecharts/service.cljc"],"mappings":"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","names":["statecharts$service$IService$start$dyn","x__4509__auto__","m__4510__auto__","statecharts.service/start","goog/typeOf","m__4508__auto__","cljs.core/missing-protocol","statecharts$service$IService$send$dyn","statecharts.service/send","statecharts$service$IService$add_listener$dyn","statecharts.service/add-listener","statecharts$service$IService$reload$dyn","statecharts.service/reload","statecharts.service/IService","this","event","id","listener","fsm","statecharts.service/wrap-listener","f","_","old","new","cljs.core/PROTOCOL_SENTINEL","cljs.core/deref","this__4450__auto__","writer__4451__auto__","opt__4452__auto__","cljs.core/-write","statecharts.service/Service","statecharts.service/->Service","state","running","clock","statecharts.service/attach-fsm-scheduler","cljs.core/reset!","statecharts.impl.initialize","statecharts.impl.transition","cljs.core/add-watch","fsm_","statecharts.service/default-opts","statecharts.clock/wall-clock","var_args","G__12794","statecharts.service/service","js/Error","statecharts.service.service","opts","map__12798","cljs.core/--destructure-map","cljs.core.get","cljs.core.merge","cljs.core.atom","service","cljs.core.assoc","p1__12799#","statecharts.delayed/make-scheduler"],"sourcesContent":["(ns statecharts.service\n  (:require [statecharts.impl :as impl]\n            [statecharts.clock :as clock]\n            [statecharts.delayed :as fsm.d])\n  (:refer-clojure :exclude [send]))\n\n(defprotocol IService\n  (start [this])\n  (send [this event])\n  (add-listener [this id listener])\n  (reload [this fsm]))\n\n(declare attach-fsm-scheduler)\n\n(defn wrap-listener [f]\n  (fn [_ _ old new]\n    (f old new)))\n\n(deftype Service [^:volatile-mutable fsm\n                  state\n                  ^:volatile-mutable running\n                  clock]\n  IService\n  (start [this]\n    (when-not running\n      (set! running true)\n      (set! fsm (attach-fsm-scheduler this fsm))\n      (reset! state (impl/initialize fsm))\n      @state))\n  (send [_ event]\n    (reset! state (impl/transition fsm @state event))\n    @state)\n  (add-listener [_ id listener]\n    (add-watch state id (wrap-listener listener)))\n  (reload [this fsm_]\n    (set! fsm (attach-fsm-scheduler this fsm_))\n    nil))\n\n(defn default-opts []\n  {:clock (clock/wall-clock)})\n\n(defn service\n  ([fsm]\n   (service fsm nil))\n  ([fsm opts]\n   (let [{:keys [clock]} (merge (default-opts) opts)]\n     (Service. fsm\n               ;; state\n               (atom nil)\n               ;; running\n               false\n               clock))))\n\n(defn attach-fsm-scheduler [service fsm]\n  (assoc fsm :scheduler (fsm.d/make-scheduler\n                         ;; dispatch\n                         #(send service %)\n                         ;; clock\n                         (.-clock ^Service service))))\n"]}